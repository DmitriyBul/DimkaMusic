<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DimkaMusic main page</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"
    />
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
          integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
    <link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css' rel='stylesheet'>
    <link href=" {% static 'css/style.css' %}" rel="stylesheet" type="text/css"/>

</head>
<body>
<div class="sidebar">
    <div class="logo_content">
        <div class="logo">
            <i class='bx bxl-python'></i>
            <div class="logo_name">DimkaMusic</div>
        </div>
        <i class='bx bx-menu' id="btn"></i>
    </div>
    <ul class="nav_list">
        <li>
            <i class='bx bx-search'></i>
            <form class="search_form" action="{% url 'music:search' %}" method="get">
                <input name="q" type="text" placeholder="Search">
                <button type="submit">
                </button>
            </form>
            <span class="tooltip">Search</span>
        </li>
        <li>
            <a href="{% url 'music:home' %}">
                <i class='bx bxs-home'></i>
                <span class="links_name">Main Page</span>
            </a>
            <span class="tooltip">Main Page</span>
        </li>
        <li>
            <a href="{% url 'music:artists' %}">
                <i class='bx bx-music'></i>
                <span class="links_name">Music Library</span>
            </a>
            <span class="tooltip">Music Library</span>
        </li>
        <li>
            <a href="{% url 'accounts:profile' %}">
                <i class='bx bx-user'></i>
                <span class="links_name">User</span>
            </a>
            <span class="tooltip">User</span>
        </li>
        {% if user.is_authenticated %}
        <li>
            <a href="{% url 'music:my_playlists' %}">
                <i class="fas fa-bars"></i>
                <span class="links_name">My Playlists</span>
            </a>
            <span class="tooltip">My Playlists</span>
        </li>
        {% endif %}
        <li>
            <a href="{% url 'accounts:dashboard' %}">
                <i class='bx bx-heart'></i>
                <span class="links_name">My Library</span>
            </a>
            <span class="tooltip">Favourite</span>
        </li>
        <li>
            <a href="{% url 'music:new_albums' %}">
                <i class='bx bx-star'></i>
                <span class="links_name">News</span>
            </a>
            <span class="tooltip">News</span>
        </li>
        <li>
            <a href="{% url 'music:tags_list' %}">
                <i class='bx bx-receipt'></i>
                <span class="links_name">Genres</span>
            </a>
            <span class="tooltip">Genres</span>
        </li>
        <li>
            <a href="{% url 'music:popular_albums' %}">
                <i class='bx bx-headphone'></i>
                <span class="links_name">Popular</span>
            </a>
            <span class="tooltip">Popular</span>
        </li>
        <li>
            <a href="{% url 'music:albums' %}">
                <i class='bx bx-album'></i>
                <span class="links_name">Albums</span>
            </a>
            <span class="tooltip">Albums</span>
        </li>
        <li>
            <a href="{% url 'music:random_song' %}">
                <i class='fas fa-dice'></i>
                <span class="links_name">Random song</span>
            </a>
            <span class="tooltip">Random song</span>
        </li>
    </ul>
    <div class="profile_content">
        <div class="profile">
            <div class="profile_details">
                {% if user.is_authenticated %}
                    <img src="{{ user_profile.photo.url }}">
                    <div class="name_job">
                        <div class="name">{{ user.username }}</div>
                    </div>
                {% else %}
                    <img src="{% static 'images/profile.png' %}">
                    <div class="name_job">
                        <a href="{% url 'accounts:register' %}">Register </a> or
                        <a href="{% url 'accounts:login' %}"> Login</a>
                        <div class="name">{{ user.username }}</div>
                    </div>

                {% endif %}
            </div>
            <a href="{% url 'accounts:logout' %}"><i class='bx bx-log-out' id="log_out"></i></a>
        </div>
    </div>
</div>
<div class="home_content">
    {% block content %}{% endblock %}


    <footer>
        <div class="footer-col">
            <h3>Top Albums</h3>
            <li>Manage Reputation</li>
            <li>Power Tools</li>
            <li>Managed Website</li>
            <li>Marketing Service</li>
        </div>
        <div class="footer-col">
            <h3>Top Albums</h3>
            <li>Manage Reputation</li>
            <li>Power Tools</li>
            <li>Managed Website</li>
            <li>Marketing Service</li>
        </div>
        <div class="footer-col">
            <h3>Top Albums</h3>
            <li>Manage Reputation</li>
            <li>Power Tools</li>
            <li>Managed Website</li>
            <li>Marketing Service</li>
        </div>
        <div class="footer-col">
            <h3>Top Albums</h3>
            <li>Manage Reputation</li>
            <li>Power Tools</li>
            <li>Managed Website</li>
            <li>Marketing Service</li>
        </div>
        <div class="footer-col">
            <h3>Newsletter</h3>
            <p>You can send me email</p>
            <div class="subscribe">
                <input type="text" placeholder="Your Email address">
                <a href="#" class="yellow">Subscribe</a>
            </div>
        </div>
        <div class="copyright">
            <p>This template built by Dimka Robotnic</p>
            <div class="pro-links">
                <div><a href="https://github.com/DmitriyBul"><i class='bx bxl-github'></i></a></div>
            </div>
        </div>
    </footer>
</div>
</body>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>

<script>
    let delayInMilliseconds = 1000; //1 second

    setTimeout(function () {
        //your code to be executed after 1 second
    }, delayInMilliseconds);

    let btn = document.querySelector("#btn");
    let sidebar = document.querySelector(".sidebar");
    let searchBtn = document.querySelector(".bx-search");
    btn.onclick = function () {
        sidebar.classList.toggle("active");
    };
    btn.onclick = function () {
        sidebar.classList.toggle("active");
    };
    let previous = document.querySelector('#pre');
    let play = document.querySelector('#play');
    let next = document.querySelector('#next');
    let title = document.querySelector('#title');
    let recent_volume = document.querySelector('#volume');
    let volume_show = document.querySelector('#volume_show');
    let slider = document.querySelector('#duration_slider');
    let show_duration = document.querySelector('#show_duration');
    let track_image = document.querySelector('#track_image');
    let auto_play = document.querySelector('#auto');
    let present = document.querySelector('#present');
    let total = document.querySelector('#total');
    let artist = document.querySelector('#artist');

    let curr_time = document.querySelector(".current-time");
    let total_duration = document.querySelector(".total-duration");
    var duration;

    let timer;
    let autoplay = 1;

    let index_no = 0;
    let playing_song = false;

    let song_1 = document.getElementById("1");
    let track = document.getElementById("mysong");
    track.setAttribute("preload", "metadata");
    let tracks_count = '{{ songs_count }}';
    let current_number = '{{ song.number_in_album }}';
    let count = document.getElementsByClassName('song').length;
    let song_data = [];
    let name_data = [];
    let singer_name = '{{album.artist}}';
    console.log(tracks_count);
    console.log(current_number);


    function load_track() {
        clearInterval(timer);
        reset_slider();
        track.src = '{{ song.file.url|safe }}';
        title.innerHTML = '{{ song.name }}';
        artist.innerHTML = '{{ album.artist }}';
        track_image.src = '{{album.image.url}}';
        track.load();
        timer = setInterval(range_slider, 1000);
    }

    load_track();
    let isPlaying = track.currentTime > 0 && !track.paused && !track.ended && track.readyState > track.HAVE_CURRENT_DATA;
    window.onload = function () {
        if (track.currentTime == 0 && !isPlaying && autoplay == 1) {
            setTimeout(2000);
            justplay();
            track.play();
            play.innerHTML = '<i class="fa fa-pause"></i>';

        }


    };


    if (track.ended) {
        track.pause();
        playing_song = false;
        play.innerHTML = '<i class="fa fa-play"></i>';
        window.location.href = "{% url 'music:random_song' %}";


    }
    if (track.currentTime == 0 && !isPlaying) {
        setTimeout(2000);
        justplay()
    }


    function mute_sound() {
        track.volume = 0;
        volume.value = 0;
        volume_show.innerHTML = 0;
    }

    function reset_slider() {
        slider.value = 0;
    }

    function justplay() {
        if (playing_song == false) {
            playsong();
        } else {
            pausesong();
        }
    }

    function playsong() {
        track.play();
        playing_song = true;
        play.innerHTML = '<i class="fa fa-pause"></i>';
    }

    function pausesong() {
        track.pause();
        playing_song = false;
        play.innerHTML = '<i class="fa fa-play"></i>';
    }

    function next_song() {
        if (index_no < All_song.length - 1) {
            index_no += 1;
            load_track(index_no);
            playsong();
        } else {
            index_no = 0;
            load_track(index_no);
            playsong();
        }
    }

    function previous_song() {
        if (index_no > 0) {
            index_no -= 1;
            load_track(index_no);
            playsong();
        } else {
            index_no = All_song.length;
            load_track(index_no);
            playsong();
        }
    }

    function volume_change() {
        volume_show.innerHTML = recent_volume.value;
        track.volume = recent_volume.value / 100;
    }

    function change_duration() {
        slider_position = track.duration * (slider.value / 100);

        track.currentTime = slider_position;
        track.play();
    }

    function autoplay_switch() {
        if (autoplay == 1) {
            autoplay = 0;
            auto_play.style.background = "rgba(255,255,255,0.2)";
        } else {
            autoplay = 1;
            auto_play.style.background = "#FF8A65";
        }
    }

    function range_slider() {
        let position = 0;

        if (!isNaN(track.duration)) {
            position = track.currentTime * (100 / track.duration);
            slider.value = position;
            let currentMinutes = Math.floor(track.currentTime / 60);
            let currentSeconds = Math.floor(track.currentTime - currentMinutes * 60);
            let durationMinutes = Math.floor(track.duration / 60);
            let durationSeconds = Math.floor(track.duration - durationMinutes * 60);

            // Add a zero to the single digit time values
            if (currentSeconds < 10) {
                currentSeconds = "0" + currentSeconds;
            }
            if (durationSeconds < 10) {
                durationSeconds = "0" + durationSeconds;
            }
            if (currentMinutes < 10) {
                currentMinutes = "0" + currentMinutes;
            }
            if (durationMinutes < 10) {
                durationMinutes = "0" + durationMinutes;
            }

            // Display the updated duration
            curr_time.textContent = currentMinutes + ":" + currentSeconds;
            total_duration.textContent = durationMinutes + ":" + durationSeconds;
        }
        if (track.ended && autoplay == 1) {
            track.pause();
            playing_song = false;
            play.innerHTML = '<i class="fa fa-play"></i>';
            if (current_number != tracks_count) {
                window.location.href = "{% url 'music:random_song'  %}";

            }


        }
    }


    const one = document.getElementById('first');
    const two = document.getElementById('second');
    const three = document.getElementById('third');
    const four = document.getElementById('fourth');
    const five = document.getElementById('fifth');
    const arr = [one, two, three, four, five];

    const form = document.querySelector('.rate-form');
    const confirmBox = document.getElementById('confirm-box');
    const csrf = document.getElementsByName('csrfmiddlewaretoken');


    function initStarValues() {
        const children = form.children;
        for (let i = 0; i < children.length; i++) {
            if (i <= '{{ rating }}') {
                children[i].classList.add('checked');
            } else {
                children[i].classList.remove('checked');
            }
        }
    }

    initStarValues();
    const handleStarSelect = (size) => {
        const children = form.children;
        for (let i = 0; i < children.length; i++) {
            if (i <= size) {
                children[i].classList.add('checked')
            } else {
                children[i].classList.remove('checked')
            }
        }
    };

    const handleSelect = (selection) => {

        switch (selection) {
            case 'first': {
                // one.classList.add('checked')
                // two.classList.remove('checked')
                // three.classList.remove('checked')
                // four.classList.remove('checked')
                // five.classList.remove('checked')
                handleStarSelect(1);
                return
            }
            case 'second': {
                handleStarSelect(2);
                return
            }
            case 'third': {
                handleStarSelect(3);
                return
            }
            case 'fourth': {
                handleStarSelect(4);
                return
            }
            case 'fifth': {
                handleStarSelect(5);
                return
            }
            default: {
                handleStarSelect(0);
            }
        }

    };

    const getNumericValue = (stringValue) => {
        let numericValue;
        if (stringValue === 'first') {
            numericValue = 1;
        }
        else if (stringValue === 'second') {
            numericValue = 2;
        }
        else if (stringValue === 'third') {
            numericValue = 3;
        }
        else if (stringValue === 'fourth') {
            numericValue = 4;
        }
        else if (stringValue === 'fifth') {
            numericValue = 5;
        }
        else {
            numericValue = 0;
        }
        return numericValue
    };

    if (one) {
        const arr = [one, two, three, four, five];

        arr.forEach(item => item.addEventListener('mouseover', (event) => {
            handleSelect(event.target.id)
        }));

        arr.forEach(item => item.addEventListener('click', (event) => {
            // value of the rating not numeric
            const val = event.target.id;

            let isSubmit = false;
            form.addEventListener('submit', e => {
                e.preventDefault();
                if (isSubmit) {
                    return
                }
                isSubmit = true;
                // picture id
                const id = e.target.id;
                // value of the rating translated into numeric
                const val_num = getNumericValue(val);

                $.ajax({
                    type: 'POST',
                    url: 'rate_album/',
                    data: {
                        'csrfmiddlewaretoken': csrf[0].value,
                        'el_id': id,
                        'val': val_num,
                    },
                    success: function (response) {
                        console.log(response);
                        confirmBox.innerHTML = `Successfully rated with ${response.score}`;
                    },
                    error: function (error) {
                        console.log(error);
                        confirmBox.innerHTML = 'Successfully rated';
                    }
                })
            })
        }))
    }
<!-- Initialize Swiper -->

      var swiper = new Swiper(".mySwiper", {
        slidesPerView: 3,
        spaceBetween: 30,
        slidesPerGroup: 3,
        loop: true,
        loopFillGroupWithBlank: true,
        pagination: {
          el: ".swiper-pagination",
          clickable: true,
        },
        navigation: {
          nextEl: ".swiper-button-next",
          prevEl: ".swiper-button-prev",
        },
      });
</script>
</html>